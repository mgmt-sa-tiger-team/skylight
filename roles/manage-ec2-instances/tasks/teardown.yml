---
- name: Get the VPC ID for {{ name_prefix }}
  ec2_vpc_net_facts:
    filters:
      "tag:Name": "{{ name_prefix }}-vpc"
    region: "{{ ec2_region }}"
  register: vpc_net_facts

- name: use set fact for easier variables
  set_fact:
    ec2_vpc_id: "{{ vpc_net_facts.vpcs[0].id }}"
  when: vpc_net_facts.vpcs|length > 0

# ----------------------- Destroy Tower Instances -----------------------
- name: Get ec2 Tower instance information
  ec2_instance_facts:
    region: "{{ ec2_region }}"
    filters:
      vpc-id: "{{ ec2_vpc_id }}"
      "tag:Name": "{{ name_prefix + '-s' + item + '-tower'}}"
  with_sequence: count={{ user_count }}
  register: ec2_tower_instances

- name: Terminate Tower Instances
  ec2:
    region: "{{ ec2_region }}"
    state: "absent"
    instance_ids: "{{ item.instances | map(attribute='instance_id') | list }}"
  with_items:
    - "{{ ec2_tower_instances.results }}"
  when: item.instances.0 is defined and item.instances.0.instance_id is defined

# ----------------------- Destroy Gitlab Instances -----------------------
- name: Get ec2 Gitlab instance information
  ec2_instance_facts:
    region: "{{ ec2_region }}"
    filters:
      vpc-id: "{{ ec2_vpc_id }}"
      "tag:Name": "{{ name_prefix }}-gitlab"
  register: ec2_gitlab_instances

- name: Terminate Gitlab Instances
  ec2:
    region: "{{ ec2_region }}"
    state: "absent"
    instance_ids: "{{ item.instances | map(attribute='instance_id') | list }}"
  with_items:
    - "{{ ec2_gitlab_instances }}"
  when: item.instances.0 is defined

# ----------------------- Destroy Docs Instances -----------------------
- name: Get ec2 Docs instance information
  ec2_instance_facts:
    region: "{{ ec2_region }}"
    filters:
      vpc-id: "{{ ec2_vpc_id }}"
      "tag:Name": "{{ name_prefix }}-docs"
  register: ec2_docs_instances

- name: Terminate Docs Instances
  ec2:
    region: "{{ ec2_region }}"
    state: "absent"
    instance_ids: "{{ item.instances | map(attribute='instance_id') | list }}"
  with_items:
    - "{{ ec2_docs_instances }}"
  when: item.instances.0 is defined

# ----------------------- Destroy DC Instances -----------------------
- name: Get ec2 DC instance information
  ec2_instance_facts:
    region: "{{ ec2_region }}"
    filters:
      vpc-id: "{{ ec2_vpc_id }}"
      "tag:Name": "{{ name_prefix }}-windc"
  register: ec2_dc_instances

- name: Terminate DC Instances
  ec2:
    region: "{{ ec2_region }}"
    state: "absent"
    instance_ids: "{{ item.instances | map(attribute='instance_id') | list }}"
  with_items:
    - "{{ ec2_dc_instances }}"
  when: item.instances.0 is defined

# ----------------------- Destroy Windows Instances -----------------------
- name: Get ec2 Windows instance information
  ec2_instance_facts:
    region: "{{ ec2_region }}"
    filters:
      vpc-id: "{{ ec2_vpc_id }}"
      "tag:Name": "{{ name_prefix + '-s' + item + '-win1'}}"
  with_sequence: count={{user_count}}
  register: ec2_windows_instances

- name: Terminate Windows Instances
  ec2:
    region: "{{ ec2_region }}"
    state: "absent"
    instance_ids: "{{ item.instances | map(attribute='instance_id') | list }}"
  with_items:
    - "{{ ec2_windows_instances.results }}"
  when: item.instances.0 is defined and item.instances.0.instance_id is defined

# ----------------------- Destroy Workstation Instances -----------------------
- name: Get ec2 Workstation instance information
  ec2_instance_facts:
    region: "{{ ec2_region }}"
    filters:
      vpc-id: "{{ ec2_vpc_id }}"
      "tag:Name": "{{ name_prefix + '-s' + item + '-work'}}"
  with_sequence: count={{user_count}}
  register: ec2_workstation_instances

- name: Terminate Workstation Instances
  ec2:
    region: "{{ ec2_region }}"
    state: "absent"
    instance_ids: "{{ item.instances | map(attribute='instance_id') | list }}"
  with_items:
    - "{{ ec2_workstation_instances.results }}"
  when: item.instances.0 is defined and item.instances.0.instance_id is defined

################### Remove Security Groups ###################

- name: Remove Tower security group
  ec2_group:
    name: "{{ name_prefix }}-towersg"
    vpc_id: "{{ ec2_vpc_id }}"
    state: absent
  register: result
  until: result is success
  retries: 20
  delay: 10

- name: Remove Gitlab security group
  ec2_group:
    name: "{{ name_prefix }}-gitlabsg"
    vpc_id: "{{ ec2_vpc_id }}"
    state: absent
  register: result
  until: result is success
  retries: 20
  delay: 10

- name: Remove Docs security group
  ec2_group:
    name: "{{ name_prefix }}-docssg"
    vpc_id: "{{ ec2_vpc_id }}"
    state: absent
  register: result
  until: result is success
  retries: 20
  delay: 10

- name: Remove DC security group
  ec2_group:
    name: "{{ name_prefix }}-windcsg"
    vpc_id: "{{ ec2_vpc_id }}"
    state: absent
  register: result
  until: result is success
  retries: 20
  delay: 10

- name: Remove Web security group
  ec2_group:
    name: "{{ name_prefix }}-websg"
    vpc_id: "{{ ec2_vpc_id }}"
    state: absent
  register: result
  until: result is success
  retries: 20
  delay: 10

- name: Remove Windows security group
  ec2_group:
    name: "{{ name_prefix }}-windowssg"
    vpc_id: "{{ ec2_vpc_id }}"
    state: absent
  register: result
  until: result is success
  retries: 20
  delay: 10

- name: Remove subnet for {{ name_prefix }}-vpc
  ec2_vpc_subnet:
    region: "{{ ec2_region }}"
    vpc_id: "{{ ec2_vpc_id }}"
    cidr: "{{ ptr_zone_cidr }}"
    state: absent
  register: result
  until: result is success
  retries: 20
  delay: 10

- name: Remove VPC {{ name_prefix }}-vpc
  ec2_vpc_net:
    name: "{{ name_prefix }}-vpc"
    cidr_block: "{{ ptr_zone_cidr }}"
    region: "{{ ec2_region }}"
    state: absent
  register: result
  until: result is success
  retries: 20
  delay: 10
